@using e_Pas_CMS.ViewModels
@model AuditChecklistNode

@{
    bool hasChildren = Model.Children != null && Model.Children.Any();
    bool isQuestion = Model.Type == "QUESTION";
    var collapseId = $"collapse-{Model.Id}";
    decimal? score = Model.ScoreAF ?? 0;
    decimal? scoreX = Model.ScoreX ?? score;
}

<li class="mb-3">
    <div class="p-3 border bg-light rounded shadow-sm">
        <div class="d-flex justify-content-between align-items-center">
            <a class="text-decoration-none fw-bold d-flex align-items-center gap-2"
               data-bs-toggle="collapse"
               href="#@collapseId"
               role="button"
               aria-expanded="false"
               aria-controls="@collapseId">
                <i class="bi bi-chevron-down rotate-arrow"></i> @Model.Title
            </a>

            @if (scoreX.HasValue)
            {
                <span class="text-end text-muted fw-normal">Skor: <strong>@scoreX.Value.ToString("0.00")</strong></span>
            }
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.Description))
        {
            <div class="text-muted mt-1">@Model.Description</div>
        }

        @if (isQuestion)
        {
            <div class="mt-3">
                <div class="mb-2"><strong>Jawaban:</strong></div>
                <div class="d-flex gap-2 flex-wrap">
                    @foreach (var opt in new[] { "A", "B", "C", "D", "E", "F" })
                    {
                        var value = opt switch
                        {
                            "A" => 1.00m,
                            "B" => 0.80m,
                            "C" => 0.60m,
                            "D" => 0.40m,
                            "E" => 0.20m,
                            "F" => 0.00m,
                            _ => 0.00m
                        };

                        bool active = Model.ScoreInput == opt;
                        <button type="button"
                                class="btn option-btn @(active ? "btn-success text-white" : "btn-outline-secondary")"
                                data-node-id="@Model.Id"
                                data-score="@opt">
                            @($"{opt} ({value:0.00})")
                        </button>
                    }
                </div>

                <div class="mt-2">
                    <button class="btn btn-sm btn-secondary me-2 cancel-score-btn">Batal</button>
                    <button class="btn btn-sm btn-primary update-score-btn"
                            data-node-id="@Model.Id"
                            data-audit-id="@ViewBag.AuditId">
                        Update Nilai
                    </button>
                </div>

                @if (!string.IsNullOrWhiteSpace(Model.media_path))
                {
                    <div class="mt-2">
                        <a class="text-decoration-none text-primary" target="_blank" href="@Model.media_path">
                            <i class="bi bi-link-45deg"></i> Lihat Dokumentasi Foto / Video
                        </a>
                    </div>
                }
            </div>
        }

        @if (hasChildren)
        {
            <div class="collapse mt-3" id="@collapseId">
                <ul class="list-unstyled ms-3">
                    @foreach (var child in Model.Children)
                    {
                        <li>@await Html.PartialAsync("_ChecklistNode", child)</li>
                    }
                </ul>
            </div>
        }
    </div>
</li>
