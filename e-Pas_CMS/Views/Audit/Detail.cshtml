@using e_Pas_CMS.ViewModels
@model DetailAuditViewModel

@{
    ViewData["Title"] = "Detail Hasil Audit";
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<h3 class="mb-4 fw-bold">Detail Hasil Audit</h3>

<div class="mb-4">
    <a href="#" class="text-decoration-none">Review Audit /</a>
    <span class="text-primary fw-semibold">Detail hasil audit - @Model.ReportNo</span>
</div>

<div class="alert alert-@(Model.Status == "PASS" ? "success" : "danger") text-center fs-4">
    @Model.Status.ToUpper()
</div>

<div class="row mb-5">
    <div class="col-md-4"><strong>No. Report:</strong><br />@Model.ReportNo</div>
    <div class="col-md-4"><strong>Nama Auditor:</strong><br />@Model.NamaAuditor</div>
    <div class="col-md-4"><strong>Tanggal Submit:</strong><br />@Model.TanggalSubmit?.ToString("dd/MM/yyyy, HH:mm")</div>
    <div class="col-md-4"><strong>Nomor SPBU:</strong><br />@Model.SpbuNo</div>
    <div class="col-md-4"><strong>Provinsi SPBU:</strong><br />@Model.Provinsi</div>
    <div class="col-md-4"><strong>Kabupaten/Kota SPBU:</strong><br />@Model.Kota</div>
    <div class="col-md-12 mt-3"><strong>Alamat SPBU:</strong><br />@Model.Alamat</div>
</div>

<ul class="list-unstyled">
@foreach (var node in Model.Elements)
{
    RenderChecklistNode(node, 0);
}
</ul>

<div class="text-end mt-5">
    <button class="btn btn-primary rounded-pill px-4 py-2" data-bs-toggle="modal" data-bs-target="#confirmModal">
        Setujui Laporan Audit
    </button>
</div>

<!-- Modal Konfirmasi -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Konfirmasi Persetujuan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
            </div>
            <div class="modal-body">
                Apakah Anda yakin ingin menyetujui laporan audit ini?
            </div>
            <div class="modal-footer">
                <form method="post" asp-action="Approve" asp-route-id="@Context.Request.RouteValues["id"]">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Ya, Setujui</button>
                </form>
            </div>
        </div>
    </div>
</div>

@functions {
    decimal ExtractDecimalFromOption(string opt)
    {
        var match = System.Text.RegularExpressions.Regex.Match(opt, @"\((.*?)\)");
        return match.Success && decimal.TryParse(match.Groups[1].Value, out var val) ? val : 0;
    }

    void RenderChecklistNode(AuditChecklistNode node, int level)
    {
        <li class="mb-3 ps-@(level * 3)">
            <div class="card border-secondary">
                <div class="card-header bg-light">
                    <strong>@node.Title</strong>
                    <span class="float-end">Skor: @(node.ScoreAF?.ToString("0.00") ?? "0.00")</span>
                </div>
                <div class="card-body">
                    <div class="mb-2">Tipe: <span class="badge bg-info text-dark">@node.Type</span></div>

                    @if (!string.IsNullOrWhiteSpace(node.ScoreInput))
                    {
                        <div class="mb-2">
                            <div class="mb-1 fw-semibold">Jawaban:</div>
                            @foreach (var opt in new List<string> { "A (2,00)", "B (1,50)", "C (1,00)", "D (0,50)", "F (0,00)" })
                            {
                                var optionValue = ExtractDecimalFromOption(opt);
                                var isActive = decimal.TryParse(node.ScoreInput, out var actual) && optionValue == actual;

                                <button class="btn btn-outline-secondary btn-sm me-2 @(isActive ? "active bg-success text-white" : "")">
                                    @opt
                                </button>
                            }
                        </div>

                        <div>
                            <button class="btn btn-light btn-sm me-2">Batal</button>
                            <button class="btn btn-primary btn-sm">Update Nilai</button>
                        </div>
                    }

                    @if (node.Children.Any())
                    {
                        <ul class="list-unstyled mt-3">
                        @foreach (var child in node.Children)
                        {
                            RenderChecklistNode(child, level + 1);
                        }
                        </ul>
                    }
                </div>
            </div>
        </li>
    }
}