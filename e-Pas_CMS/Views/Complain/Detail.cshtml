@inject e_Pas_CMS.Data.EpasDbContext _context
@using System.Security.Claims
@using System

@model e_Pas_CMS.ViewModels.ComplainDetailViewModel
@{
    ViewData["Title"] = Model.IsBanding ? "Detail Banding" : "Detail Komplain";

    string statusClass = "bg-warning";
    string statusText = Model.StatusText ?? "-";
    switch ((Model.StatusCode ?? "").Trim().ToUpperInvariant())
    {
        case "APPROVE_PPN":
        case "APPROVE":
            statusClass = "bg-success";
            break;
        case "REJECTED": statusClass = "bg-danger"; break;
        default: statusClass = "bg-warning"; break;
    }

    var userIdString = Context.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

    bool hasApproveRoleSBM = false;
    bool hasApproveRolePPN = false;
    bool hasRoleCBI = false;

    if (!string.IsNullOrEmpty(userIdString))
    {
        // 1x roundtrip ke DB: ambil role yang relevan saja
        var wanted = new[] { "SBM", "PPN", "CBI" };

        var roleSet = new HashSet<string>(
            (from ur in _context.app_user_roles
             join r in _context.app_roles on ur.app_role_id equals r.id
             where ur.app_user_id == userIdString && wanted.Contains(r.name)
             select r.name).ToList(),
            StringComparer.OrdinalIgnoreCase // aman untuk case-insensitive
        );

        hasApproveRoleSBM = roleSet.Contains("SBM");
        hasApproveRolePPN = roleSet.Contains("PPN");
        hasRoleCBI = roleSet.Contains("CBI");
    }
}

<style>
    .card-soft { border: 1px solid #eef2f7; border-radius: .75rem; }
    .section-title { font-weight: 600; font-size: 1.05rem; margin-bottom: .75rem; }
    .kv .label { color: #6b7280; font-size: .85rem; }
    .kv .value { font-weight: 500; }
    .banner-status { border-radius: .75rem; text-align: center; padding: .95rem 1rem; }
    .muted { color: #6b7280; }
    .min-h-row { min-height: 28px; }
    .table-sm th, .table-sm td { vertical-align: middle; }
    .point-title { font-weight: 600; margin-bottom: .5rem; }
    .divider { height: 1px; background: #eef2f7; margin: 1rem 0; }

    .btn-gradient-green {
        background: linear-gradient(135deg, #10b981, #059669);
        color: #fff;
        border: none;
    }

        .btn-gradient-green:hover {
            background: linear-gradient(135deg, #059669, #047857);
            color: #fff;
        }

    .btn-gradient-red {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #fff;
        border: none;
    }

        .btn-gradient-red:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: #fff;
        }

    .btn-gradient-blue {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: #fff;
        border: none;
    }

        .btn-gradient-blue:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
        }

    /* Efek hover scale */
    .hover-scale {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .hover-scale:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

</style>

<div class="container-fluid px-0">
    <!-- Breadcrumb + Title -->
    <div class="mb-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb small mb-1">
                <li class="breadcrumb-item"><a asp-controller="Complain" asp-action="Index">Komplain &amp; Banding</a></li>
                <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
            </ol>
        </nav>
        <h4 class="mb-0">@ViewData["Title"]</h4>
    </div>

    <!-- Status Banner (kuning/merah/hijau sesuai status) -->
    @if (Model.feedback_type != "COMPLAINT")
    {
        <div class="mb-3">
            <div class="banner-status @statusClass text-white">
                <h4 class="fw-bold mb-0">@statusText</h4>
            </div>
        </div>
    }

    <!-- Informasi SPBU -->
    <div class="card card-soft mb-3">
        <div class="card-body">
            <div class="section-title">Informasi SPBU</div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 kv">
                <div class="col">
                    <div class="label">Nomor SPBU</div>
                    <div class="value min-h-row">@Model.NoSpbu</div>
                </div>
                <div class="col">
                    <div class="label">Region</div>
                    <div class="value min-h-row">@Model.Region</div>
                </div>
                <div class="col">
                    <div class="label">Kabupaten/Kota</div>
                    <div class="value min-h-row">@Model.City</div>
                </div>
                <div class="col">
                    <div class="label">Alamat SPBU</div>
                    <div class="value min-h-row">@Model.Address</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informasi Kegiatan Audit -->
    <div class="card card-soft mb-3">
        <div class="card-body">
            <div class="section-title">Informasi Kegiatan Audit</div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 kv">
                <div class="col">
                    <div class="label">No. Report</div>
                    <div class="value">@Model.ReportNo</div>
                </div>
                <div class="col">
                    <div class="label">Tanggal Audit</div>
                    <div class="value">
                        @(Model.TanggalAudit.HasValue ? Model.TanggalAudit.Value.ToString("dd/MM/yyyy, HH:mm") + " WIB" : "-")
                    </div>
                </div>
                <div class="col">
                    <div class="label">Sent Date</div>
                    <div class="value">
                        @(Model.SentDate.HasValue ? Model.SentDate.Value.ToString("dd/MM/yyyy, HH:mm") + " WIB" : "-")
                    </div>
                </div>
                <div class="col">
                    <div class="label">Verifikator</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.Verifikator) ? Model.Verifikator : "-")</div>
                </div>
                <div class="col">
                    <div class="label">Auditor 1</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.Auditor1) ? Model.Auditor1 : "-")</div>
                </div>
                <div class="col">
                    <div class="label">Auditor 2</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.Auditor2) ? Model.Auditor2 : "-")</div>
                </div>
                <div class="col">
                    <div class="label">Tipe Audit</div>
                    <div class="value">@Model.TipeAudit</div>
                </div>
                <div class="col">
                    <div class="label">Next Audit</div>
                    <div class="value">@Model.NextAudit</div>
                </div>
                <div class="col">
                    <div class="label">Ko-ordinator</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.Koordinator) ? Model.Koordinator : "-")</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informasi Banding/Komplain -->
    <div class="card card-soft mb-3">
        <div class="card-body">
            <div class="section-title">Informasi @(Model.IsBanding ? "Banding" : "Komplain")</div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 kv">
                @if (Model.feedback_type != "COMPLAINT")
                {
                    <div class="col">
                        <div class="label">Status @(Model.IsBanding ? "Banding" : "Komplain")</div>
                        <div class="value">@statusText</div>
                    </div>
                }
                
                <div class="col">
                    <div class="label">Nomor Tiket</div>
                    <div class="value">@Model.TicketNo</div>
                </div>
                <div class="col">
                    <div class="label">Nomor Banding</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.NomorBanding) ? Model.NomorBanding : "-")</div>
                </div>
                <div class="col">
                    <div class="label">Tgl Pengajuan</div>
                    <div class="value">
                        @(Model.CreatedDate.HasValue ? Model.CreatedDate.Value.ToString("dd/MM/yyyy, HH:mm") + " WIB" : "-")
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daftar Poin Banding/Komplain (per poin seperti gambar) -->
    @if (Model.Points != null && Model.Points.Any())
    {
        var idx = 1;
        foreach (var p in Model.Points)
        {
            <div class="card card-soft mb-3">
                <div class="card-body">
                    <div class="point-title">Poin @idx</div>

                    <div class="table-responsive mb-3">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:140px">Element</th>
                                    <th style="width:160px">Sub Element</th>
                                    <th style="width:180px">Detail Element</th>
                                    <th>Element yang @(Model.IsBanding ? "dibanding" : "dikomplain")</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>@(string.IsNullOrWhiteSpace(p.Element) ? "-" : p.Element)</td>
                                    <td>@(string.IsNullOrWhiteSpace(p.SubElement) ? "-" : p.SubElement)</td>
                                    <td>@(string.IsNullOrWhiteSpace(p.DetailElement) ? "-" : p.DetailElement)</td>
                                    <td>@(string.IsNullOrWhiteSpace(p.DetailDibantah) ? "-" : p.DetailDibantah)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-2 fw-semibold">Isi @(Model.IsBanding ? "Banding" : "Komplain")</div>
                    <div class="muted mb-3">
                        @(string.IsNullOrWhiteSpace(p.Description) ? "-" : p.Description)
                    </div>
                    @* ================== BEGIN: Dokumen Pendukung (versi seperti Audit Detail) ================== *@
                    <div class="mb-2 fw-semibold">Dokumen Pendukung</div>

                    @if (p.Attachments != null && p.Attachments.Any())
                    {
                        <div class="row g-3">
                            @foreach (var f in p.Attachments)
                            {
                                var mt = (f.MediaType ?? "").ToLowerInvariant();
                                var isImage = mt == "jpg" || mt == "jpeg" || mt == "png" || mt == "gif";
                                var isVideo = mt == "mp4" || mt == "webm" || mt == "mov";
                                var isPdf = mt == "pdf";

                                <div class="col-6 col-md-4 col-lg-3">
                                    <div class="card h-100 border-0 shadow-sm attachment-card">
                                        <div class="ratio ratio-4x3 bg-light position-relative overflow-hidden">
                                            @if (isImage)
                                            {
                                                <img src="@f.Url" alt="@f.FileName" class="w-100 h-100 object-fit-cover" />
                                            }
                                            else if (isVideo)
                                            {
                                                <div class="d-flex align-items-center justify-content-center w-100 h-100">
                                                    <i class="bi bi-camera-reels fs-1 text-muted"></i>
                                                </div>
                                            }
                                            else if (isPdf)
                                            {
                                                <div class="d-flex align-items-center justify-content-center w-100 h-100">
                                                    <i class="bi bi-filetype-pdf fs-1 text-danger"></i>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="d-flex align-items-center justify-content-center w-100 h-100">
                                                    <i class="bi bi-file-earmark-text fs-1 text-muted"></i>
                                                </div>
                                            }

                                            <!-- Hover overlay actions seperti di audit -->
                                            <div class="attachment-actions d-flex gap-2 position-absolute top-50 start-50 translate-middle">
                                                <button type="button"
                                                        class="btn btn-light btn-sm shadow-sm fw-semibold px-3 btn-preview"
                                                        data-id="@f.Id"
                                                        data-url="@f.Url"
                                                        data-filename="@(!string.IsNullOrWhiteSpace(f.FileName) ? f.FileName : "Lampiran")"
                                                        data-mediatype="@mt">
                                                    <i class="bi bi-eye me-1"></i> Lihat
                                                </button>

                                                <a asp-controller="Complain"
                                                   asp-action="Download"
                                                   asp-route-id="@f.Id"
                                                   class="btn btn-primary btn-sm shadow-sm fw-semibold px-3">
                                                    <i class="bi bi-download me-1"></i> Unduh
                                                </a>
                                            </div>
                                        </div>

                                        <div class="card-body p-2">
                                            <div class="small fw-semibold text-truncate" title="@f.FileName">
                                                @(!string.IsNullOrWhiteSpace(f.FileName) ? f.FileName : "Lampiran")
                                            </div>
                                            @if (!string.IsNullOrEmpty(f.SizeReadable))
                                            {
                                                <div class="text-muted small">@f.SizeReadable</div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="muted">Tidak ada dokumen pendukung.</div>
                    }
                    @* ================== END: Dokumen Pendukung ================== *@

                </div>
            </div>
            idx++;
        }
    }
    <!-- Tombol aksi -->
    <div class="d-flex flex-wrap gap-2 align-items-center mb-4">
        <a asp-controller="Complain" asp-action="Index"
           class="btn btn-outline-secondary rounded-pill px-4 py-2 shadow-sm hover-scale">
            <i class="bi bi-arrow-left-circle"></i> Kembali
        </a>

        @if (Model.StatusCode == "IN_PROGRESS_SUBMIT" && hasApproveRoleSBM && Model.feedback_type != "COMPLAINT")
        {
            <form asp-action="Approve" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <button type="submit" class="btn btn-gradient-green rounded-pill px-4 py-2 shadow-sm hover-scale me-2">
                    <i class="bi bi-check-circle"></i> Approve
                </button>
            </form>

            <form asp-action="Reject" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <button type="submit" class="btn btn-gradient-red rounded-pill px-4 py-2 shadow-sm hover-scale">
                    <i class="bi bi-x-circle"></i> Reject
                </button>
            </form>
        }

        @if (Model.StatusCode == "APPROVE_SBM" && hasApproveRolePPN && Model.feedback_type != "COMPLAINT")
        {
            <form asp-action="Approve" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <button type="submit" class="btn btn-gradient-green rounded-pill px-4 py-2 shadow-sm hover-scale me-2">
                    <i class="bi bi-check-circle"></i> Approve
                </button>
            </form>

            <form asp-action="Reject" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <button type="submit" class="btn btn-gradient-red rounded-pill px-4 py-2 shadow-sm hover-scale">
                    <i class="bi bi-x-circle"></i> Reject
                </button>
            </form>
        }

        @if (Model.StatusCode == "APPROVE_PPN" && hasRoleCBI && Model.feedback_type != "COMPLAINT")
        {
            <button class="btn btn-gradient-blue rounded-pill px-4 py-2 shadow-sm hover-scale"
                    data-bs-toggle="modal" data-bs-target="#confirmModal">
                <i class="bi bi-arrow-repeat"></i> Reassign Laporan Audit
            </button>
        }
    </div>

</div>

@* ================== BEGIN: Modal Preview Lampiran ================== *@
<!-- Modal Konfirmasi -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Konfirmasi Persetujuan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
            </div>
            <div class="modal-body">
                Apakah Anda yakin ingin mengembalikan laporan audit ini?
            </div>
            <div class="modal-footer">
                <form method="post"
                      asp-controller="Complain"
                      asp-action="Reassign"
                      asp-route-id="@Model.Id">
                    @Html.AntiForgeryToken()
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Ya, Setujui</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="attachmentPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="attachmentTitle">Pratinjau Lampiran</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
            </div>
            <div class="modal-body">
                <!-- Konten dinamis: img / video / pdf / generic -->
                <div id="attachmentViewer" class="w-100"></div>
            </div>
            <div class="modal-footer justify-content-between">
                <div class="d-flex gap-2">
                    <a id="btnOpenNewTab" href="#" target="_blank" rel="noopener" class="btn btn-outline-secondary">
                        <i class="bi bi-box-arrow-up-right me-1"></i> Buka di Tab Baru
                    </a>
                </div>
                <div class="d-flex gap-2">
                    <a id="btnDownload" class="btn btn-primary">
                        <i class="bi bi-download me-1"></i> Unduh
                    </a>
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
</div>
@* ================== END: Modal Preview Lampiran ================== *@

@section Scripts {
    <script>
        (function () {
          const modalEl = document.getElementById('attachmentPreviewModal');
          const viewer  = document.getElementById('attachmentViewer');
          const titleEl = document.getElementById('attachmentTitle');
          const btnOpen = document.getElementById('btnOpenNewTab');
          const btnDown = document.getElementById('btnDownload');

          // Delegate: klik tombol Lihat
          document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-preview');
            if (!btn) return;

            const url  = btn.getAttribute('data-url');
            const name = btn.getAttribute('data-filename') || 'Lampiran';
            const mt   = (btn.getAttribute('data-mediatype') || '').toLowerCase();

            // Set judul & tombol aksi
            titleEl.textContent = name;
            btnOpen.href = url;

            const id = btn.getAttribute('data-id');
            btnDown.href = '@Url.Action("Download", "Complain")' + '/' + id;

            // Render preview
            viewer.innerHTML = '';
            let html = '';

            if (['jpg','jpeg','png','gif','webp'].includes(mt)) {
              html = '<img src="' + url + '" alt="' + name + '" class="img-fluid w-100">';
            } else if (['mp4','webm','mov'].includes(mt)) {
              html = '<video src="' + url + '" controls class="w-100" playsinline></video>';
            } else if (mt === 'pdf') {
              // iframe untuk PDF
              html = '<iframe src="' + url + '" class="w-100" style="height:70vh" frameborder="0"></iframe>';
            } else {
              // fallback generic
              html = '<div class="text-center text-muted py-5">' +
                     '<i class="bi bi-file-earmark-text fs-1 d-block mb-2"></i>' +
                     '<div>Tidak ada pratinjau untuk tipe berkas ini.</div>' +
                     '</div>';
            }

            viewer.insertAdjacentHTML('afterbegin', html);

            // Tampilkan modal
            const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
            bsModal.show();
          });

          // Bersihkan viewer saat modal ditutup (stop video, bebaskan memori)
          modalEl.addEventListener('hidden.bs.modal', function () {
            viewer.innerHTML = '';
          });
        })();
    </script>
}