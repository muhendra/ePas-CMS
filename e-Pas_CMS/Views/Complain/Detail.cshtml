@model e_Pas_CMS.ViewModels.ComplainDetailViewModel
@{
    ViewData["Title"] = Model.IsBanding ? "Detail Banding" : "Detail Komplain";

    string statusClass = "bg-warning";
    string statusText = Model.StatusText ?? "-";
    switch ((Model.StatusCode ?? "").Trim().ToUpperInvariant())
    {
        case "APPROVED": statusClass = "bg-success"; break;
        case "REJECTED": statusClass = "bg-danger"; break;
        default: statusClass = "bg-warning"; break;
    }
}

<style>
    .card-soft { border: 1px solid #eef2f7; border-radius: .75rem; }
    .section-title { font-weight: 600; font-size: 1.05rem; margin-bottom: .75rem; }
    .kv .label { color: #6b7280; font-size: .85rem; }
    .kv .value { font-weight: 500; }
    .banner-status { border-radius: .75rem; text-align: center; padding: .95rem 1rem; }
    .muted { color: #6b7280; }
    .min-h-row { min-height: 28px; }
    .table-sm th, .table-sm td { vertical-align: middle; }
    .point-title { font-weight: 600; margin-bottom: .5rem; }
    .divider { height: 1px; background: #eef2f7; margin: 1rem 0; }
</style>

<div class="container-fluid px-0">
    <!-- Breadcrumb + Title -->
    <div class="mb-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb small mb-1">
                <li class="breadcrumb-item"><a asp-controller="Complain" asp-action="Index">Komplain &amp; Banding</a></li>
                <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
            </ol>
        </nav>
        <h4 class="mb-0">@ViewData["Title"]</h4>
    </div>

    <!-- Status Banner (kuning/merah/hijau sesuai status) -->
    <div class="mb-3">
        <div class="banner-status @statusClass text-white">
            <h4 class="fw-bold mb-0">@statusText</h4>
        </div>
    </div>

    <!-- Informasi SPBU -->
    <div class="card card-soft mb-3">
        <div class="card-body">
            <div class="section-title">Informasi SPBU</div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 kv">
                <div class="col">
                    <div class="label">Nomor SPBU</div>
                    <div class="value min-h-row">@Model.NoSpbu</div>
                </div>
                <div class="col">
                    <div class="label">Region</div>
                    <div class="value min-h-row">@Model.Region</div>
                </div>
                <div class="col">
                    <div class="label">Kabupaten/Kota</div>
                    <div class="value min-h-row">@Model.City</div>
                </div>
                <div class="col">
                    <div class="label">Alamat SPBU</div>
                    <div class="value min-h-row">@Model.Address</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informasi Kegiatan Audit -->
    <div class="card card-soft mb-3">
        <div class="card-body">
            <div class="section-title">Informasi Kegiatan Audit</div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 kv">
                <div class="col">
                    <div class="label">No. Report</div>
                    <div class="value">@Model.ReportNo</div>
                </div>
                <div class="col">
                    <div class="label">Tanggal Audit</div>
                    <div class="value">
                        @(Model.TanggalAudit.HasValue ? Model.TanggalAudit.Value.ToString("dd/MM/yyyy, HH:mm") + " WIB" : "-")
                    </div>
                </div>
                <div class="col">
                    <div class="label">Sent Date</div>
                    <div class="value">
                        @(Model.SentDate.HasValue ? Model.SentDate.Value.ToString("dd/MM/yyyy, HH:mm") + " WIB" : "-")
                    </div>
                </div>
                <div class="col">
                    <div class="label">Verifikator</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.Verifikator) ? Model.Verifikator : "-")</div>
                </div>
                <div class="col">
                    <div class="label">Auditor 1</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.Auditor1) ? Model.Auditor1 : "-")</div>
                </div>
                <div class="col">
                    <div class="label">Auditor 2</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.Auditor2) ? Model.Auditor2 : "-")</div>
                </div>
                <div class="col">
                    <div class="label">Tipe Audit</div>
                    <div class="value">@Model.TipeAudit</div>
                </div>
                <div class="col">
                    <div class="label">Next Audit</div>
                    <div class="value">@Model.NextAudit</div>
                </div>
                <div class="col">
                    <div class="label">Ko-ordinator</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.Koordinator) ? Model.Koordinator : "-")</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informasi Banding/Komplain -->
    <div class="card card-soft mb-3">
        <div class="card-body">
            <div class="section-title">Informasi @(Model.IsBanding ? "Banding" : "Komplain")</div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 kv">
                <div class="col">
                    <div class="label">Status @(Model.IsBanding ? "Banding" : "Komplain")</div>
                    <div class="value">@statusText</div>
                </div>
                <div class="col">
                    <div class="label">Nomor Tiket</div>
                    <div class="value">@Model.TicketNo</div>
                </div>
                <div class="col">
                    <div class="label">Nomor Banding</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.NomorBanding) ? Model.NomorBanding : "-")</div>
                </div>
                <div class="col">
                    <div class="label">Tgl Pengajuan</div>
                    <div class="value">
                        @(Model.CreatedDate.HasValue ? Model.CreatedDate.Value.ToString("dd/MM/yyyy, HH:mm") + " WIB" : "-")
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daftar Poin Banding/Komplain (per poin seperti gambar) -->
    @if (Model.Points != null && Model.Points.Any())
    {
        var idx = 1;
        foreach (var p in Model.Points)
        {
            <div class="card card-soft mb-3">
                <div class="card-body">
                    <div class="point-title">Poin @idx</div>

                    <div class="table-responsive mb-3">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:140px">Element</th>
                                    <th style="width:160px">Sub Element</th>
                                    <th style="width:180px">Detail Element</th>
                                    <th>Element yang @(Model.IsBanding ? "dibanding" : "dikomplain")</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>@(string.IsNullOrWhiteSpace(p.Element) ? "-" : p.Element)</td>
                                    <td>@(string.IsNullOrWhiteSpace(p.SubElement) ? "-" : p.SubElement)</td>
                                    <td>@(string.IsNullOrWhiteSpace(p.DetailElement) ? "-" : p.DetailElement)</td>
                                    <td>@(string.IsNullOrWhiteSpace(p.DetailDibantah) ? "-" : p.DetailDibantah)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-2 fw-semibold">Isi @(Model.IsBanding ? "Banding" : "Komplain")</div>
                    <div class="muted mb-3">
                        @(string.IsNullOrWhiteSpace(p.Description) ? "-" : p.Description)
                    </div>

                    <div class="mb-2 fw-semibold">Dokumen Pendukung</div>

                    @if (p.Attachments != null && p.Attachments.Any())
                    {
                        <div class="row g-3">
                            @foreach (var f in p.Attachments)
                            {
                                // Pastikan Anda sudah isi MediaType & Url dari controller kalau mau preview
                                var mt = (f.MediaType ?? "").ToLowerInvariant();
                                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                                    <div class="card h-100 shadow-sm border-0">
                                        <div class="ratio ratio-4x3 bg-light d-flex align-items-center justify-content-center overflow-hidden">
                                            @if (mt == "jpg" || mt == "jpeg" || mt == "png" || mt == "gif")
                                            {
                                                <img src="@f.Url" alt="@f.FileName" class="w-100 h-100 object-fit-cover" />
                                            }
                                            else if (mt == "mp4" || mt == "webm")
                                            {
                                                <video src="@f.Url" class="w-100 h-100" controls></video>
                                            }
                                            else if (mt == "pdf")
                                            {
                                                <i class="bi bi-filetype-pdf fs-1 text-danger"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-file-earmark-text fs-1 text-muted"></i>
                                            }
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="small fw-semibold text-truncate" title="@f.FileName">
                                                @(!string.IsNullOrWhiteSpace(f.FileName) ? f.FileName : "Lampiran")
                                            </div>
                                            @if (!string.IsNullOrEmpty(f.SizeReadable))
                                            {
                                                <div class="text-muted small">@f.SizeReadable</div>
                                            }
                                        </div>
                                        <div class="card-footer bg-transparent border-0 pt-0 pb-2">
                                            <a asp-controller="Complain"
                                               asp-action="Download"
                                               asp-route-id="@f.Id"
                                               class="btn btn-outline-primary btn-sm w-100">
                                                Unduh
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="muted">Tidak ada dokumen pendukung.</div>
                    }

                </div>
            </div>
            idx++;
        }
    }

    <!-- Tombol aksi -->
    <div class="d-flex gap-2">
        <a asp-controller="Complain" asp-action="Index" class="btn btn-outline-secondary">&laquo; Kembali</a>

        @if (Model.CanApprove)
        {
            <form asp-controller="Complain" asp-action="Approve" method="post" class="d-inline">
                <input type="hidden" name="id" value="@Model.Id" />
                <button type="submit" class="btn btn-success">Setujui</button>
            </form>
        }
        @if (Model.CanReject)
        {
            <a asp-controller="Complain" asp-action="Reject" asp-route-id="@Model.Id" class="btn btn-danger">Tolak</a>
        }
    </div>
</div>