@model YourApp.Controllers.UploadLibraryController.LibraryVm
@using static YourApp.Controllers.UploadLibraryController
@using System

@{
    ViewData["Title"] = "Upload Library";

    int window = 5; // jumlah tombol halaman di sekitar current
    int startPage = Math.Max(1, Model.Page - window);
    int endPage = Math.Min(Model.TotalPages, Model.Page + window);
}

<style>
    /* ✅ bikin kolom fixed biar Size tidak ketutup */
    .uploadlib-table {
        table-layout: fixed;
        width: 100%;
    }

    /* ✅ truncate text panjang */
    .uploadlib-name {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: bottom;
    }

    /* biar link juga ikut truncate */
    .uploadlib-name-link {
        display: inline-flex;
        gap: .35rem;
        align-items: center;
        max-width: 100%;
        min-width: 0;
    }

    .uploadlib-badge {
        font-size: 11px;
        padding: .2rem .45rem;
    }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-1">Upload Library</h4>
            <div class="text-muted">Base: /var/www/epas-asset/wwwroot/uploads</div>
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-warning">@TempData["Error"]</div>
    }

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            @for (int i = 0; i < Model.Breadcrumbs.Count; i++)
            {
                var (name, rel) = Model.Breadcrumbs[i];
                var isLast = i == Model.Breadcrumbs.Count - 1;

                if (isLast)
                {
                    <li class="breadcrumb-item active">@name</li>
                }
                else
                {
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "UploadLibrary", new { folder = rel, q = Model.Query, page = 1, pageSize = Model.PageSize })">@name</a>
                    </li>
                }
            }
        </ol>
    </nav>

    <!-- Search -->
    <form method="get" action="/UploadLibrary" class="row g-2 mb-3">
        <input type="hidden" name="folder" value="@Model.CurrentRel" />
        <input type="hidden" name="page" value="1" />
        <input type="hidden" name="pageSize" value="@Model.PageSize" />

        <div class="col-md-6">
            <input class="form-control" name="q" value="@Model.Query" placeholder="Search nama file/folder..." />
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" type="submit">Search</button>
        </div>
        <div class="col-md-2">
            <a class="btn btn-outline-secondary w-100"
               href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, page = 1, pageSize = Model.PageSize })">
                Reset
            </a>
        </div>
    </form>

    <div class="card">
        <div class="card-body">

            <div class="table-responsive">
                <table class="table table-hover align-middle uploadlib-table">
                    <!-- ✅ enforce width kolom biar Size tetap terlihat -->
                    <colgroup>
                        <col style="width:40%">
                        <col style="width:15%">
                        <col style="width:15%">
                        <col style="width:20%">
                        <col style="width:10%">
                    </colgroup>

                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Modified</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>

                    <tbody>
                        @if (Model.Items == null || !Model.Items.Any())
                        {
                            <tr>
                                <td colspan="5" class="text-muted">Tidak ada data.</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var item in Model.Items)
                            {
                                if (item.IsDir)
                                {
                                    <tr>
                                        <td>
                                            <a class="uploadlib-name-link"
                                               href="@Url.Action("Index", "UploadLibrary", new { folder = item.RelPath, q = Model.Query, page = 1, pageSize = Model.PageSize })"
                                               title="Audit ID: @item.Name">
                                                <span>📁</span>

                                                <!-- ✅ tampilkan spbu_no (DisplayName) -->
                                                <span class="uploadlib-name">@item.DisplayName</span>

                                                @if (item.IsMappedFromAudit)
                                                {
                                                    <span class="badge bg-info uploadlib-badge">SPBU</span>
                                                }
                                            </a>
                                        </td>
                                        <td>Folder</td>
                                        <td class="text-muted">
                                            @(item.ChildCount.HasValue ? $"{item.ChildCount.Value} items" : "-")
                                        </td>
                                        <td>@item.LastWriteTime.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td class="text-end">
                                            <form method="post" action="/UploadLibrary/DeleteFolder" class="d-inline"
                                                  onsubmit="return confirm('Hapus folder kosong (Audit ID): @item.Name ?');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="path" value="@item.RelPath" />
                                                <input type="hidden" name="returnFolder" value="@Model.CurrentRel" />
                                                <input type="hidden" name="q" value="@Model.Query" />
                                                <input type="hidden" name="page" value="@Model.Page" />
                                                <input type="hidden" name="pageSize" value="@Model.PageSize" />
                                                <button class="btn btn-sm btn-outline-danger">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    <tr>
                                        <td title="@item.Name">
                                            <span class="uploadlib-name-link">
                                                <span>📄</span>
                                                <span class="uploadlib-name">@item.DisplayName</span>
                                            </span>
                                        </td>
                                        <td>File</td>
                                        <td>@(item.SizeBytes.HasValue ? HumanSize(item.SizeBytes.Value) : "-")</td>
                                        <td>@item.LastWriteTime.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td class="text-end">
                                            <a class="btn btn-sm btn-outline-primary"
                                               href="/UploadLibrary/Download?path=@Uri.EscapeDataString(item.RelPath)">
                                                Download
                                            </a>

                                            <form method="post" action="/UploadLibrary/DeleteFile" class="d-inline"
                                                  onsubmit="return confirm('Hapus file: @item.Name ?');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="path" value="@item.RelPath" />
                                                <input type="hidden" name="returnFolder" value="@Model.CurrentRel" />
                                                <input type="hidden" name="q" value="@Model.Query" />
                                                <input type="hidden" name="page" value="@Model.Page" />
                                                <input type="hidden" name="pageSize" value="@Model.PageSize" />
                                                <button class="btn btn-sm btn-outline-danger">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mt-3 gap-2">
                <div class="text-muted">
                    Total: <b>@Model.TotalItems</b> item • Page <b>@Model.Page</b> / <b>@Model.TotalPages</b>
                </div>

                <form method="get" action="/UploadLibrary" class="d-flex align-items-center gap-2">
                    <input type="hidden" name="folder" value="@Model.CurrentRel" />
                    <input type="hidden" name="q" value="@Model.Query" />
                    <input type="hidden" name="page" value="1" />
                    <label class="text-muted mb-0">Page size</label>
                    <select class="form-select form-select-sm" name="pageSize" onchange="this.form.submit()">
                        @foreach (var ps in Model.AllowedPageSizes)
                        {
                            <option value="@ps" selected="@(ps == Model.PageSize)">@ps</option>
                        }
                    </select>
                </form>

                <nav aria-label="pagination">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, q = Model.Query, page = 1, pageSize = Model.PageSize })">«</a>
                        </li>

                        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, q = Model.Query, page = Model.Page - 1, pageSize = Model.PageSize })">‹</a>
                        </li>

                        @for (int p = startPage; p <= endPage; p++)
                        {
                            <li class="page-item @(p == Model.Page ? "active" : "")">
                                <a class="page-link"
                                   href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, q = Model.Query, page = p, pageSize = Model.PageSize })">@p</a>
                            </li>
                        }

                        <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, q = Model.Query, page = Model.Page + 1, pageSize = Model.PageSize })">›</a>
                        </li>

                        <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, q = Model.Query, page = Model.TotalPages, pageSize = Model.PageSize })">»</a>
                        </li>
                    </ul>
                </nav>
            </div>

        </div>
    </div>
</div>
