@model YourApp.Controllers.UploadLibraryController.LibraryVm
@using static YourApp.Controllers.UploadLibraryController
@using System
@using System.IO
@using IOPath = System.IO.Path

@{
    ViewData["Title"] = "Upload Library";

    int window = 5; // jumlah tombol halaman di sekitar current
    int startPage = Math.Max(1, Model.Page - window);
    int endPage = Math.Min(Model.TotalPages, Model.Page + window);
}

<style>
    /* ✅ bikin kolom fixed biar Size tidak ketutup */
    .uploadlib-table {
        table-layout: fixed;
        width: 100%;
    }

    /* ✅ truncate text panjang */
    .uploadlib-name {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: bottom;
    }

    /* biar link juga ikut truncate */
    .uploadlib-name-link {
        display: inline-flex;
        gap: .35rem;
        align-items: center;
        max-width: 100%;
        min-width: 0;
    }

    .uploadlib-badge {
        font-size: 11px;
        padding: .2rem .45rem;
    }

    /* ✅ Action buttons rapi */
    .action-cell {
        display: flex;
        justify-content: flex-end;
        gap: .5rem;
        flex-wrap: nowrap;
        align-items: center;
        white-space: nowrap;
    }

    .btn-action {
        min-width: 86px;
        padding: .25rem .55rem;
        line-height: 1.15;
    }

        .btn-action.btn-sm {
            border-radius: .35rem;
        }

    /* ✅ toolbar (download/delete bulan) */
    .month-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: .5rem;
        align-items: center;
        margin-bottom: 1rem;
    }

        .month-toolbar .btn {
            border-radius: .45rem;
        }

    /* ✅ modal preview */
    .preview-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.6);
        display: none;
        z-index: 1055;
    }

    .preview-modal {
        position: fixed;
        inset: 0;
        display: none;
        z-index: 1060;
        overflow: auto;
        padding: 2rem 1rem;
    }

    .preview-card {
        max-width: 980px;
        margin: 0 auto;
        background: #fff;
        border-radius: .5rem;
        box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: .75rem 1rem;
        border-bottom: 1px solid #eee;
        gap: .75rem;
    }

    .preview-title {
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 75%;
    }

    .preview-body {
        padding: 1rem;
    }

        .preview-body img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .preview-body video {
            width: 100%;
            max-height: 70vh;
            display: block;
            margin: 0 auto;
        }

    .btn-icon {
        border: 0;
        background: transparent;
        font-size: 1.25rem;
        line-height: 1;
        padding: .25rem .5rem;
    }

    /* ✅ modal download confirm (reuse style mirip preview) */
    .dl-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.5);
        display: none;
        z-index: 1065;
    }

    .dl-modal {
        position: fixed;
        inset: 0;
        display: none;
        z-index: 1070;
        overflow: auto;
        padding: 2rem 1rem;
    }

    .dl-card {
        max-width: 720px;
        margin: 0 auto;
        background: #fff;
        border-radius: .5rem;
        box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }

    .dl-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: .75rem 1rem;
        border-bottom: 1px solid #eee;
        gap: .75rem;
    }

    .dl-title {
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 80%;
    }

    .dl-body {
        padding: 1rem;
    }

    .dl-footer {
        display: flex;
        justify-content: flex-end;
        gap: .5rem;
        padding: .75rem 1rem;
        border-top: 1px solid #eee;
    }

    .dl-note {
        color: #6c757d;
        font-size: .9rem;
        margin-top: .5rem;
    }

    .dl-box {
        background: #f8f9fa;
        border: 1px solid #eee;
        padding: .75rem 1rem;
        border-radius: .35rem;
        font-weight: 600;
    }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-1">Upload Library</h4>
            <div class="text-muted">Base: /var/www/epas-asset/wwwroot/uploads</div>
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-warning">@TempData["Error"]</div>
    }

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            @for (int i = 0; i < Model.Breadcrumbs.Count; i++)
            {
                var (name, rel) = Model.Breadcrumbs[i];
                var isLast = i == Model.Breadcrumbs.Count - 1;

                if (isLast)
                {
                    <li class="breadcrumb-item active">@name</li>
                }
                else
                {
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "UploadLibrary", new { folder = rel, q = Model.Query, month = Model.Month, page = 1, pageSize = Model.PageSize })">@name</a>
                    </li>
                }
            }
        </ol>
    </nav>

    <!-- Filter: Search + Month -->
    <form method="get" action="/UploadLibrary" class="row g-2 mb-2">
        <input type="hidden" name="folder" value="@Model.CurrentRel" />
        <input type="hidden" name="page" value="1" />
        <input type="hidden" name="pageSize" value="@Model.PageSize" />

        <div class="col-md-5">
            <input class="form-control" name="q" value="@Model.Query" placeholder="Search nama file/folder..." />
        </div>

        <div class="col-md-3">
            <select class="form-select" id="monthSelect" name="month" onchange="this.form.submit()">
                <option value="">-- Semua Bulan --</option>
                @foreach (var ym in Model.AvailableMonths)
                {
                    <option value="@ym" selected="@(Model.Month == ym)">@ym</option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <button class="btn btn-primary w-100" type="submit">Filter</button>
        </div>

        <div class="col-md-2">
            <a class="btn btn-outline-secondary w-100"
               href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, page = 1, pageSize = Model.PageSize })">
                Reset
            </a>
        </div>
    </form>

    <!-- Actions: Download/Delete for Selected Month -->
    <div class="month-toolbar">
        <!-- ✅ CHANGED: bukan link langsung ke DownloadMonth, tapi popup -> open Downloads tab -->
        <button type="button"
                class="btn btn-outline-primary @(string.IsNullOrEmpty(Model.Month) ? "disabled" : "")"
                onclick="openDownloadMonthPopup()">
            Download ZIP (Selected Month)
        </button>

        <form method="post" action="/UploadLibrary/DeleteMonth" class="m-0"
              onsubmit="return confirm('Yakin DELETE semua asset untuk bulan ' + document.getElementById('monthSelect').value + ' ? Ini akan hapus folder/file (folder recursive).');">
            @Html.AntiForgeryToken()
            <input type="hidden" name="folder" value="@Model.CurrentRel" />
            <input type="hidden" name="q" value="@Model.Query" />
            <input type="hidden" name="month" value="@Model.Month" />
            <input type="hidden" name="page" value="@Model.Page" />
            <input type="hidden" name="pageSize" value="@Model.PageSize" />

            <button type="submit" class="btn btn-outline-danger" @(string.IsNullOrEmpty(Model.Month) ? "disabled" : "")>
                Delete All Assets (Selected Month)
            </button>
        </form>
    </div>

    <div class="card">
        <div class="card-body">

            <div class="table-responsive">
                <table class="table table-hover align-middle uploadlib-table">
                    <colgroup>
                        <col style="width:40%">
                        <col style="width:15%">
                        <col style="width:15%">
                        <col style="width:20%">
                        <col style="width:10%">
                    </colgroup>

                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Modified</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>

                    <tbody>
                        @if (Model.Items == null || !Model.Items.Any())
                        {
                            <tr>
                                <td colspan="5" class="text-muted">Tidak ada data.</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var item in Model.Items)
                            {
                                if (item.IsDir)
                                {
                                    <tr>
                                        <td>
                                            <a class="uploadlib-name-link"
                                               href="@Url.Action("Index", "UploadLibrary", new { folder = item.RelPath, q = Model.Query, month = Model.Month, page = 1, pageSize = Model.PageSize })"
                                               title="Audit ID: @item.Name">
                                                <span>📁</span>
                                                <span class="uploadlib-name">@item.DisplayName</span>
                                                @if (item.IsMappedFromAudit)
                                                {
                                                    <span class="badge bg-info uploadlib-badge">SPBU</span>
                                                }
                                            </a>
                                        </td>
                                        <td>Folder</td>
                                        <td class="text-muted">@(item.ChildCount.HasValue ? $"{item.ChildCount.Value} items" : "-")</td>
                                        <td>@item.LastWriteTime.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td class="text-end">
                                            <div class="action-cell">
                                                <!-- ✅ CHANGED: tombol popup -> open Downloads tab -->
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-primary btn-action"
                                                        onclick="openDownloadFolderPopup('@item.RelPath','@item.DisplayName')"
                                                        title="Download ZIP untuk folder/SPBU ini">
                                                    Download
                                                </button>

                                                <form method="post" action="/UploadLibrary/DeleteFolder" class="m-0"
                                                      onsubmit="return confirm('Hapus folder (jika kosong): @item.Name ?');">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="path" value="@item.RelPath" />
                                                    <input type="hidden" name="returnFolder" value="@Model.CurrentRel" />
                                                    <input type="hidden" name="q" value="@Model.Query" />
                                                    <input type="hidden" name="month" value="@Model.Month" />
                                                    <input type="hidden" name="page" value="@Model.Page" />
                                                    <input type="hidden" name="pageSize" value="@Model.PageSize" />
                                                    <button class="btn btn-sm btn-outline-danger btn-action" type="submit">Delete</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    var ext = (System.IO.Path.GetExtension(item.Name ?? "") ?? "").ToLowerInvariant();
                                    var isImg = ext == ".jpg" || ext == ".jpeg" || ext == ".png" || ext == ".gif" || ext == ".webp";
                                    var isVid = ext == ".mp4" || ext == ".webm" || ext == ".ogg" || ext == ".mov" || ext == ".m4v";

                                    <tr>
                                        <td title="@item.Name">
                                            <span class="uploadlib-name-link">
                                                <span>📄</span>

                                                @if (isImg || isVid)
                                                {
                                                    <a href="javascript:void(0)"
                                                       class="uploadlib-name js-preview"
                                                       data-rel="@item.RelPath"
                                                       data-name="@item.DisplayName"
                                                       data-type="@(isImg ? "image" : "video")"
                                                       style="text-decoration: underline;">
                                                        @item.DisplayName
                                                    </a>
                                                }
                                                else
                                                {
                                                    <span class="uploadlib-name">@item.DisplayName</span>
                                                }
                                            </span>
                                        </td>
                                        <td>File</td>
                                        <td>@(item.SizeBytes.HasValue ? HumanSize(item.SizeBytes.Value) : "-")</td>
                                        <td>@item.LastWriteTime.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td class="text-end">
                                            <div class="action-cell">
                                                <a class="btn btn-sm btn-outline-primary btn-action"
                                                   href="/UploadLibrary/Download?path=@Uri.EscapeDataString(item.RelPath)">
                                                    Download
                                                </a>

                                                <form method="post" action="/UploadLibrary/DeleteFile" class="m-0"
                                                      onsubmit="return confirm('Hapus file: @item.Name ?');">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="path" value="@item.RelPath" />
                                                    <input type="hidden" name="returnFolder" value="@Model.CurrentRel" />
                                                    <input type="hidden" name="q" value="@Model.Query" />
                                                    <input type="hidden" name="month" value="@Model.Month" />
                                                    <input type="hidden" name="page" value="@Model.Page" />
                                                    <input type="hidden" name="pageSize" value="@Model.PageSize" />
                                                    <button class="btn btn-sm btn-outline-danger btn-action" type="submit">Delete</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mt-3 gap-2">
                <div class="text-muted">
                    Total: <b>@Model.TotalItems</b> item • Page <b>@Model.Page</b> / <b>@Model.TotalPages</b>
                </div>

                <form method="get" action="/UploadLibrary" class="d-flex align-items-center gap-2">
                    <input type="hidden" name="folder" value="@Model.CurrentRel" />
                    <input type="hidden" name="q" value="@Model.Query" />
                    <input type="hidden" name="month" value="@Model.Month" />
                    <input type="hidden" name="page" value="1" />
                    <label class="text-muted mb-0">Page size</label>
                    <select class="form-select form-select-sm" name="pageSize" onchange="this.form.submit()">
                        @foreach (var ps in Model.AllowedPageSizes)
                        {
                            <option value="@ps" selected="@(ps == Model.PageSize)">@ps</option>
                        }
                    </select>
                </form>

                <nav aria-label="pagination">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, q = Model.Query, month = Model.Month, page = 1, pageSize = Model.PageSize })">«</a>
                        </li>

                        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, q = Model.Query, month = Model.Month, page = Model.Page - 1, pageSize = Model.PageSize })">‹</a>
                        </li>

                        @for (int p = startPage; p <= endPage; p++)
                        {
                            <li class="page-item @(p == Model.Page ? "active" : "")">
                                <a class="page-link"
                                   href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, q = Model.Query, month = Model.Month, page = p, pageSize = Model.PageSize })">@p</a>
                            </li>
                        }

                        <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, q = Model.Query, month = Model.Month, page = Model.Page + 1, pageSize = Model.PageSize })">›</a>
                        </li>

                        <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", "UploadLibrary", new { folder = Model.CurrentRel, q = Model.Query, month = Model.Month, page = Model.TotalPages, pageSize = Model.PageSize })">»</a>
                        </li>
                    </ul>
                </nav>
            </div>

        </div>
    </div>
</div>

<!-- ✅ Preview Modal -->
<div id="previewBackdrop" class="preview-modal-backdrop"></div>
<div id="previewModal" class="preview-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="preview-card">
        <div class="preview-header">
            <div class="preview-title" id="previewTitle">Preview</div>
            <div class="d-flex gap-2">
                <a id="previewDownloadBtn" class="btn btn-sm btn-outline-primary" href="#" target="_blank" rel="noopener">Download</a>
                <button type="button" class="btn-icon" id="previewCloseBtn" aria-label="Close">✕</button>
            </div>
        </div>
        <div class="preview-body" id="previewBody"></div>
    </div>
</div>

<!-- ✅ Download Confirm Modal -->
<div id="dlBackdrop" class="dl-modal-backdrop"></div>
<div id="dlModal" class="dl-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="dl-card">
        <div class="dl-header">
            <div class="dl-title" id="dlTitle">Download</div>
            <button type="button" class="btn-icon" id="dlCloseBtn" aria-label="Close">✕</button>
        </div>
        <div class="dl-body">
            <div>Download akan diproses di tab <b>Downloads</b>.</div>
            <div class="dl-note">Di tab Downloads, user harus klik tombol <b>Start Download</b> (user action).</div>

            <div class="mt-3 dl-box" id="dlDesc"></div>

            <input type="hidden" id="dlType" />
            <input type="hidden" id="dlFolder" />
            <input type="hidden" id="dlQ" />
            <input type="hidden" id="dlMonth" />
            <input type="hidden" id="dlPath" />
        </div>
        <div class="dl-footer">
            <button type="button" class="btn btn-outline-secondary" id="dlCancelBtn">Cancel</button>
            <button type="button" class="btn btn-primary" id="dlOpenBtn">Open Downloads Tab</button>
        </div>
    </div>
</div>

<script>
    (function () {
        // ==========================
        // ✅ Preview (punyamu)
        // ==========================
        const backdrop = document.getElementById('previewBackdrop');
        const modal = document.getElementById('previewModal');
        const body = document.getElementById('previewBody');
        const title = document.getElementById('previewTitle');
        const closeBtn = document.getElementById('previewCloseBtn');
        const dlBtn = document.getElementById('previewDownloadBtn');

        function openPreview(fileName, relPath, type) {
            title.textContent = fileName || 'Preview';

            const downloadUrl = '/UploadLibrary/Download?path=' + encodeURIComponent(relPath);
            dlBtn.href = downloadUrl;

            body.innerHTML = '';

            if (type === 'image') {
                const img = document.createElement('img');
                img.src = downloadUrl;
                img.alt = fileName || 'image';
                body.appendChild(img);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.src = downloadUrl;
                video.controls = true;
                video.playsInline = true;
                body.appendChild(video);
            } else {
                body.innerHTML = '<div class="text-muted">Preview tidak didukung untuk tipe ini.</div>';
            }

            backdrop.style.display = 'block';
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }

        function closePreview() {
            const vid = body.querySelector('video');
            if (vid) {
                try { vid.pause(); vid.src = ''; } catch (e) { }
            }
            body.innerHTML = '';
            backdrop.style.display = 'none';
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }

        document.addEventListener('click', function (e) {
            const a = e.target.closest('.js-preview');
            if (!a) return;

            e.preventDefault();
            const rel = a.getAttribute('data-rel');
            const name = a.getAttribute('data-name');
            const type = a.getAttribute('data-type');
            openPreview(name, rel, type);
        });

        backdrop.addEventListener('click', closePreview);
        closeBtn.addEventListener('click', closePreview);
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closePreview();
        });

        // ==========================
        // ✅ Download Confirm Modal
        // ==========================
        const dlBackdrop = document.getElementById('dlBackdrop');
        const dlModal = document.getElementById('dlModal');
        const dlTitle = document.getElementById('dlTitle');
        const dlDesc = document.getElementById('dlDesc');
        const dlCloseBtn = document.getElementById('dlCloseBtn');
        const dlCancelBtn = document.getElementById('dlCancelBtn');
        const dlOpenBtn = document.getElementById('dlOpenBtn');

        const dlType = document.getElementById('dlType');
        const dlFolder = document.getElementById('dlFolder');
        const dlQ = document.getElementById('dlQ');
        const dlMonth = document.getElementById('dlMonth');
        const dlPath = document.getElementById('dlPath');

        function showDlModal() {
            dlBackdrop.style.display = 'block';
            dlModal.style.display = 'block';
            dlModal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }

        function hideDlModal() {
            dlBackdrop.style.display = 'none';
            dlModal.style.display = 'none';
            dlModal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }

        window.openDownloadMonthPopup = function () {
            const month = document.getElementById('monthSelect').value || '';
            if (!month) return;

            dlTitle.textContent = 'Download ZIP (Month)';
            dlDesc.textContent = 'Month: ' + month;

            dlType.value = 'month';
            dlFolder.value = '@(Model.CurrentRel ?? "")';
            dlQ.value = '@(Model.Query ?? "")';
            dlMonth.value = month;
            dlPath.value = '';

            showDlModal();
        }

        window.openDownloadFolderPopup = function (relPath, displayName) {
            dlTitle.textContent = 'Download ZIP (Folder)';
            dlDesc.textContent = 'Folder: ' + (displayName || relPath);

            dlType.value = 'spbu';
            dlFolder.value = '';
            dlQ.value = '';
            dlMonth.value = '@(Model.Month ?? "")';
            dlPath.value = relPath || '';

            showDlModal();
        }

        function buildDownloadsUrl() {
            const type = dlType.value;

            if (type === 'month') {
                return '/UploadLibrary/Downloads?type=month'
                    + '&folder=' + encodeURIComponent(dlFolder.value || '')
                    + '&q=' + encodeURIComponent(dlQ.value || '')
                    + '&month=' + encodeURIComponent(dlMonth.value || '');
            }

            // spbu/folder
            return '/UploadLibrary/Downloads?type=spbu'
                + '&path=' + encodeURIComponent(dlPath.value || '')
                + '&month=' + encodeURIComponent(dlMonth.value || '');
        }

        dlOpenBtn.addEventListener('click', function () {
            const url = buildDownloadsUrl();
            window.open(url, '_blank', 'noopener');
            hideDlModal();
        });

        dlBackdrop.addEventListener('click', hideDlModal);
        dlCloseBtn.addEventListener('click', hideDlModal);
        dlCancelBtn.addEventListener('click', hideDlModal);

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') hideDlModal();
        });
    })();
</script>
